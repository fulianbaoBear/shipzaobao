# AI早报应用部署指南

## 🚀 快速部署

### 方式一：Docker部署（推荐）

#### 1. 安装前置条件
```bash
# 安装Docker和Docker Compose
# macOS (使用Homebrew)
brew install docker docker-compose

# Ubuntu/Debian
sudo apt-get update
sudo apt-get install docker.io docker-compose

# CentOS/RHEL
sudo yum install docker docker-compose
```

#### 2. 一键部署
```bash
# 进入项目目录
cd aizaobao

# 运行部署脚本
./deploy.sh
```

#### 3. 手动部署
```bash
# 1. 构建镜像
docker-compose build

# 2. 启动服务
docker-compose up -d

# 3. 查看日志
docker-compose logs -f

# 4. 停止服务
docker-compose down
```

### 方式二：直接部署

#### 1. 安装依赖
```bash
# 安装Python依赖
pip install -r requirements.txt
```

#### 2. 配置环境
```bash
# 复制配置文件
cp config.example .env

# 编辑配置文件
vim .env
```

#### 3. 启动应用
```bash
# 开发环境
./start.sh

# 生产环境
FLASK_ENV=production ./start.sh
```

## 🔧 配置说明

### 环境变量配置
创建 `.env` 文件：
```bash
# Flask配置
FLASK_ENV=production
FLASK_DEBUG=False
SECRET_KEY=your-secret-key-here

# 应用配置
HOST=0.0.0.0
PORT=6888

# Minimax API配置（可选）
MINIMAX_GROUP_ID=your-group-id
MINIMAX_API_KEY=your-api-key
```

### Minimax API配置
1. 访问 [Minimax平台](https://platform.minimaxi.com)
2. 获取 `Group ID` 和 `API Key`
3. 在应用界面的设置面板中配置
4. 或在环境变量中预设

## 🌐 访问应用

部署成功后，访问：
- **本地访问**: http://localhost:6888
- **局域网访问**: http://[服务器IP]:6888

## 📊 运维管理

### Docker环境
```bash
# 查看运行状态
docker-compose ps

# 查看实时日志
docker-compose logs -f

# 重启服务
docker-compose restart

# 更新应用
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# 清理资源
docker-compose down --volumes --rmi all
```

### 传统部署
```bash
# 查看进程
ps aux | grep python

# 重启服务
pkill -f "python.*app.py"
./start.sh

# 查看日志
tail -f /var/log/ai-news.log
```

## 🔒 安全配置

### 1. 防火墙设置
```bash
# Ubuntu/Debian
sudo ufw allow 6888

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=6888/tcp
sudo firewall-cmd --reload
```

### 2. 反向代理（Nginx）
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:6888;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 3. SSL证书（Let's Encrypt）
```bash
# 安装Certbot
sudo apt-get install certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d your-domain.com
```

## 🐛 故障排查

### 常见问题

1. **端口占用**
```bash
# 查看端口占用
lsof -i :6888

# 杀掉占用进程
sudo kill -9 [PID]
```

2. **依赖安装失败**
```bash
# 升级pip
pip install --upgrade pip

# 清理缓存
pip cache purge

# 重新安装
pip install -r requirements.txt --force-reinstall
```

3. **Playwright浏览器问题**
如果遇到以下错误：
```
BrowserType.launch: Executable doesn't exist at /root/.cache/ms-playwright/chromium-1134/chrome-linux/chrome
```

**Docker环境（推荐）：** 
- 新版Dockerfile已自动安装Playwright浏览器
- 重新构建镜像即可解决

**本地环境解决方案：**
```bash
# 安装Playwright浏览器
playwright install chromium
playwright install-deps chromium

# 如果权限问题，使用sudo
sudo playwright install chromium
sudo playwright install-deps chromium
```

4. **权限问题**
```bash
# 修复目录权限
chmod -R 755 .
chmod +x *.sh
```

### 日志查看
```bash
# Docker环境
docker-compose logs -f ai-news

# 传统部署
tail -f app.log
```

## 🔄 更新维护

### 代码更新
```bash
# 1. 拉取最新代码
git pull

# 2. 更新依赖
pip install -r requirements.txt

# 3. 重启服务
docker-compose restart
# 或
./start.sh
```

### 数据备份
```bash
# 备份缓存数据
tar -czf backup-$(date +%Y%m%d).tar.gz cache/ static/audio/

# 恢复数据
tar -xzf backup-20250807.tar.gz
```

## 📈 性能优化

### 1. 调整Worker数量
编辑 `gunicorn.conf.py`：
```python
workers = 4  # CPU核心数 * 2
```

### 2. 缓存配置
- 缓存目录：`cache/`
- 音频目录：`static/audio/`
- 自动清理：7天前的旧文件

### 3. 监控指标
- CPU使用率
- 内存使用率
- 磁盘空间
- 网络连接数

## 📞 技术支持

如遇到问题，请提供：
1. 部署方式（Docker/直接）
2. 操作系统信息
3. 错误日志
4. 复现步骤

祝您部署顺利！🎉
